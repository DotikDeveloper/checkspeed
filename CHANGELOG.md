# Changelog

## 1.4.2 — 15.01.2026

### Обновление Зависимостей для Безопасности
- **обновление зависимостей для исключения уязвимостей**: обновлены все зависимости до последних патч-версий для устранения известных уязвимостей:
  - `iconv-lite`: ^0.7.0 → ^0.7.2
  - `next`: ^16.0.7 → ^16.1.2
  - `react`: ^19.2.1 → ^19.2.3
  - `react-dom`: ^19.2.1 → ^19.2.3
  - `@tailwindcss/postcss`: ^4.1.17 → ^4.1.18
  - `@types/node`: ^24.10.1 (без изменений, совместимо с Node.js 24)
  - `@types/react`: ^19.2.7 → ^19.2.8
  - `@vitest/coverage-v8`: ^4.0.15 → ^4.0.17
  - `eslint`: ^9.39.1 → ^9.39.2
  - `eslint-config-next`: ^16.0.7 → ^16.1.2
  - `jsdom`: ^27.2.0 → ^27.4.0
  - `tailwindcss`: ^4.1.17 → ^4.1.18
  - `vitest`: ^4.0.15 → ^4.0.17

### Исправления Ошибок
- **исправление отсутствующей зависимости для source maps**: добавлен `istanbul-lib-source-maps` версии ^5.0.6 в devDependencies, так как обновление `@vitest/coverage-v8` с версии 4.0.15 до 4.0.17 удалило эту критическую зависимость. Без неё source map remapping не работает при генерации coverage отчетов, что делает отладочные отчеты о покрытии кода неработоспособными.
- **исправление флага dev для baseline-browser-mapping**: восстановлен флаг `"dev": true` для пакета `baseline-browser-mapping` в package-lock.json. При обновлении Next.js с версии 16.0.7 до 16.1.2 этот флаг был удалён, что приводило к установке пакета в production окружении, хотя он нужен только на этапе сборки. Это увеличивало размер production bundle и могло вызывать проблемы в контейнеризованных деплоях с раздельными стадиями сборки и выполнения.
- **добавление явных требований к версии Node.js**: добавлено поле `engines` в package.json с требованием Node.js `^24.0.0` для соответствия используемой версии в Dockerfile (`node:24-alpine`). Это обеспечивает согласованность между требованиями проекта и используемым окружением, а также соответствует требованиям всех зависимостей (`jsdom` 27.4.0, `lru-cache` 11.2.4). Обновлён Dockerfile для использования фиксированной версии Node.js 24 (`node:24-alpine`) вместо плавающего тега `node:lts-alpine` для обеспечения воспроизводимых сборок и предотвращения непредсказуемых изменений при смене LTS версии.
- **исправление несовместимости версий @types/node**: понижена версия `@types/node` с `^25.0.9` до `^24.10.1` для соответствия требованиям Node.js 24, указанным в поле `engines`. Версия `@types/node` 25.x предназначена для Node.js 25.x и несовместима с Node.js 24.x, что могло вызывать проблемы с типизацией и несоответствия типов.
- **исправление Dockerfile для корректной сборки Next.js**: переработан Dockerfile с использованием multi-stage build для решения проблемы, когда `npm ci --only=production` устанавливал только production зависимости, а `npm run build` требовал devDependencies (TypeScript, postcss, tailwindcss и др.). Теперь на стадии builder устанавливаются все зависимости для сборки, а на финальной стадии runner устанавливаются только production зависимости для runtime, что обеспечивает корректную сборку и оптимизированный размер образа.

## 1.4.1 — 07.12.2025

### Критическое Обновление Безопасности
- **исправление критической уязвимости CVE-2025-29927**: обновлен Next.js с версии 16.0.1 до 16.0.7 для устранения критической уязвимости, позволяющей обходить авторизацию через заголовок `x-middleware-subrequest`;
- **исправление уязвимости в React Server Components**: обновлен React с версии 19.2.0 до 19.2.1 и react-dom до 19.2.1 для устранения уязвимости, позволяющей выполнять произвольный код на сервере;
- **обновление eslint-config-next**: обновлен eslint-config-next до версии 16.0.7 для соответствия новой версии Next.js.

### Обновление Зависимостей
- **обновление TypeScript типов**: обновлены `@types/node` с версии 22.19.1 до 24.10.1 и `@types/react` с версии 19.2.3 до 19.2.7 для поддержки последних версий Node.js и React;
- **обновление тестового фреймворка**: обновлены `vitest` и `@vitest/coverage-v8` с версии 2.1.9 до 4.0.15 (major update) для использования последних возможностей тестирования;
- **обновление Tailwind CSS**: обновлен `tailwindcss` с версии 3.4.18 до 4.1.17 (major update) с установкой `@tailwindcss/postcss` для поддержки новой архитектуры Tailwind CSS 4.x; обновлена конфигурация PostCSS для использования `@tailwindcss/postcss` вместо прямого использования `tailwindcss`.

## 1.4.0 — 02.12.2025

### Исправления Критических Ошибок
- **исправление занижения средних значений**: исправлена логика добавления результатов измерений - теперь нулевые значения от rate limiting не добавляются в серии измерений, что предотвращает искусственное занижение средних значений скорости; каждое значение (download/upload/ping) добавляется в свою серию только если оно валидно (> 0);
- **исправление расчета медианы ping**: исправлен расчет медианы ping - теперь используется функция `median()` из `stats.ts`, которая правильно обрабатывает четные массивы (берет среднее двух средних элементов), вместо неправильного `Math.floor(sortedPings.length / 2)`;
- **исправление COLD_START_SKIP**: уменьшен `COLD_START_SKIP` с 1 до 0, так как при 2 измерениях (`MEASUREMENTS_PER_SIZE = 2`) пропуск первого элемента оставлял только 1 значение для усреднения, что сводило на нет цель иметь несколько измерений для избыточности; теперь оба измерения используются для более точного результата.

### Rate Limiting и Безопасность
- **rate limiting для API endpoints**: добавлен proxy (ранее middleware) для защиты от злоупотреблений с лимитом 200 запросов в минуту с одного IP адреса (достаточно для 10 полных тестов);
- **миграция на Next.js proxy**: файл `middleware.ts` переименован в `proxy.ts`, функция `middleware` переименована в `proxy` в соответствии с новой конвенцией Next.js 16;
- **HTTP 429 при превышении лимита**: при превышении rate limit возвращается статус 429 (Too Many Requests) с заголовками `Retry-After`, `X-RateLimit-Limit`, `X-RateLimit-Remaining` и `X-RateLimit-Reset`;
- **определение IP адреса**: proxy корректно определяет IP адрес клиента с учетом заголовков прокси (`X-Forwarded-For`, `X-Real-IP`);
- **автоматическая очистка**: реализована периодическая очистка старых записей из in-memory хранилища для предотвращения утечки памяти;
- **информационные заголовки**: все ответы API содержат заголовки с информацией о текущем состоянии rate limit для клиента;
- **корректная обработка 429**: статус 429 (Too Many Requests) теперь обрабатывается как предупреждение, а не ошибка, функции измерения возвращают 0 вместо исключения, что предотвращает сбой всего процесса тестирования скорости; добавлена проверка статуса 429 в обработчике `handleLoad` для upload запросов.

### Оптимизация Процесса Измерения
- **оптимизация процесса измерения**: уменьшено количество запросов и увеличены размеры файлов для более эффективного использования rate limiting:
  - Размеры файлов: `[0.5, 1, 2, 3] МБ` → `[2, 5] МБ` (2 размера вместо 4)
  - Измерений на размер: `3` → `2` (2 измерения вместо 3)
  - Ping попыток: `10` → `8`
  - Итого запросов: `34` → `16` (download: 4, upload: 4, ping: 8)
- **сокращение количества измерений**: уменьшено количество измерений с 20 до 10 для более быстрого тестирования;
- **увеличение rate limit**: увеличен лимит запросов с 100 до 200 в минуту для поддержки 10 полных измерений (10 × 16 запросов = 160 запросов);
- **параллельное выполнение измерений**: все три теста (download, upload, ping) теперь выполняются параллельно, что значительно сокращает общее время измерения (примерно в 3 раза);
- **оптимизация внутренних измерений**: измерения для разных размеров файлов внутри каждого теста также выполняются параллельно, что дополнительно ускоряет процесс;
- **новая функция testAllSpeeds()**: добавлена функция для параллельного выполнения всех измерений с возвратом структурированных результатов;
- **улучшенная обработка результатов**: обновлен `page.tsx` для использования параллельных измерений, что сокращает время тестирования примерно в 3 раза.

### Исправления Ошибок
- **исправление ошибок при измерении upload**: убрано использование `reader.cancel()` в функциях обработки тела запроса (`consumeRequestBody`, `readRequestSize`) в `/api/upload`, что устраняет ошибку "Response body object should not be disturbed or locked"; proxy сделан асинхронным для корректной работы с Next.js 16;
- **исправление ошибки "Response body object should not be disturbed or locked"**: добавлено клонирование запроса для безопасного чтения тела при параллельном выполнении нескольких upload запросов;
- **исправление лимита размера файла**: увеличен максимальный размер файла для upload с 3 МБ до 5 МБ для соответствия размерам файлов в тестах;
- **улучшенная обработка ошибок**: добавлена обработка ошибок и нулевых результатов при измерениях, измерения продолжаются даже при rate limiting;
- **добавлена задержка при ошибках**: при ошибках или нулевых результатах добавляется задержка 1 секунда перед следующим измерением.

### Новые Возможности
- **функция выбора ближайшего сервера**: добавлена функция `findNearestServer()` для определения ближайшего сервера на основе ping (подготовка к будущему расширению с несколькими серверами);
- **индикатор прогресса**: добавлено отображение прогресса измерений в UI.

## 1.3.1 — 01.12.2025

- **исправление таймаутов upload**: уменьшен таймаут с 60 до 30 секунд для совместимости с Vercel serverless функциями;
- **оптимизация upload endpoint**: эндпоинт `/api/upload` теперь использует `Content-Length` заголовок для определения размера без чтения всего потока данных, что значительно ускоряет обработку;
- **потребление тела запроса**: добавлена функция `consumeRequestBody()` для полного потребления тела запроса во всех путях выполнения, что предотвращает проблемы в serverless окружениях (Vercel);
- **валидация Content-Length**: добавлена проверка на валидность `Content-Length` заголовка (NaN, отрицательные значения) с возвратом ошибки 400;
- **улучшена обработка ошибок**: добавлена корректная обработка таймаутов и сетевых ошибок во всех функциях измерения (`testDownloadSpeed()`, `testUploadSpeed()`, `testPing()`), неудачные попытки пропускаются без прерывания всего процесса измерения;
- **устойчивость к ошибкам**: если все попытки измерения провалились, функции возвращают 0 вместо ошибки, что предотвращает полный сбой тестирования скорости;
- **исправление порядка объявления функций**: исправлен порядок объявления `cleanup` и обработчиков событий в `measureUploadOnce()` для предотвращения `ReferenceError` (использован hoisting через `function` declaration);
- **исправление обработки ошибок от consumeRequestBody**: ошибки от `consumeRequestBody()` теперь не маскируют правильные статус-коды ответов (400, 413);
- **исправление версии в logger**: обновлен fallback версии в `logger.ts` с `1.3.0` на `1.3.1` для соответствия `package.json`.

## 1.3.0 — 24.11.2025

- **критическое исправление алгоритмов измерения скорости**: переработаны функции `testDownloadSpeed()`, `testUploadSpeed()` и `testPing()` для корректного учёта времени передачи данных;
- **download**: теперь измеряется время от начала запроса до завершения передачи (включая TTFB - Time To First Byte), что устраняет завышенные результаты на localhost;
- **upload**: улучшена точность измерения через корректную обработку событий `loadstart`/`loadend` и добавлен мониторинг прогресса передачи;
- **ping**: добавлена валидация результатов и улучшена обработка измерений;
- **логирование в продакшене**: логирование автоматически включается на localhost и может быть активировано в production через параметры;
- **валидация результатов**: добавлена проверка на нереалистично высокие значения скорости (>100 Гбит/с) и пинга (>10 секунд) с предупреждениями в логах;
- **обновлены тесты**: все unit-тесты переписаны с учётом новой логики измерения времени и добавлено мокирование logger;
- **детальное логирование**: логируются время начала/окончания замеров, промежуточные результаты, TTFB, ошибки и параметры сетевого соединения.

## 1.2.6 — 24.11.2025

- добавлен пул предсозданных буферов `BufferPool` (`src/app/api/utils/buffer-pool.ts`) для повторного использования буферов разных размеров (0.5, 1, 2, 5, 10 МБ) с ограничением пула до 10 буферов на размер;
- эндпоинт `/api/download` переведён на использование `BufferPool`, что уменьшает количество аллокаций `Buffer.alloc` под нагрузкой.

## 1.2.5 — 24.11.2025

- настроен Vitest с окружением jsdom и генерацией покрытия (`vitest.config.ts`), добавлены dev-зависимости `jsdom` и `@vitest/coverage-v8`;
- реализованы детализированные unit-тесты для `testDownloadSpeed()`, `testUploadSpeed()` и `testPing()` с моками `fetch`/`XMLHttpRequest`/`performance.now`, проверкой расчётов и путей ошибок;
- добавлены проверки покрытия (`vitest run --coverage` показывает 91.5% по `src/utils`) и чек-лист в `docs/improvements/04-GITHUB-TASKS.md`.

## 1.2.4 — 20.11.2025

- создан модуль статистики `src/utils/stats.ts` с функциями `average()`, `median()`, `removeOutliers()` и `averageWithoutColdStart()`;
- интегрирована статистическая обработка во все функции измерения (download, upload, ping) с автоматическим удалением выбросов;
- добавлены unit-тесты для всех функций статистики (26 тестов);
- рефакторинг: статистические функции вынесены в отдельный модуль для переиспользования.

## 1.2.3 — 20.11.2025

- исправлен расчёт ping: измерения выполняются 10 раз с использованием `performance.now()`, отбрасываются первое и последнее значения, результат берётся по медиане;
- добавлен специализированный эндпоинт `/api/ping` с лёгким ответом для ускорения запросов;
- удалён неиспользуемый код и добавлены unit-тесты для функции `median`.

## 1.2.2 — 20.11.2025

- ограничен максимальный размер тестовых файлов до 3 МБ как на клиенте, так и на `/api/upload`, чтобы избежать 413 на Vercel и укладываться в лимиты serverless-функций;
- скорректирован список размеров в прогрессивном тестировании upload: теперь берём 0.5–3 МБ.

## 1.2.1 — 20.11.2025

- переработана функция измерения upload-скорости: использование XMLHttpRequest с событиями `loadstart`/`loadend` для точного замера времени передачи без накладных расходов;
- реализовано прогрессивное тестирование upload с размерами файлов 0.5–10 МБ и множественными измерениями (3 на каждый размер) с отбрасыванием cold start;
- эндпоинт `/api/upload` теперь читает поток данных через Streams API, валидирует размер до 10 МБ и возвращает фактически полученный объём;
- добавлена утилита `createUploadPayload()` с unit-тестами; исправлена совместимость типов для XMLHttpRequest.send().

## 1.2.0 — 20.11.2025

- переработана функция измерения download-скорости: потоковое чтение через Streams API, последовательные размеры файлов 0.5–10 МБ и усреднение без cold start;
- эндпоинт `/api/download` принимает параметр `size`, нормализует объём и исключает кэширование;
- добавлены утилиты `bytesToMbps` и `averageWithoutColdStart` с покрытием unit-тестами на Vitest; документация дополнена инструкцией по запуску тестов.

## 1.1.0 — 12.11.2025

- обновлены ключевые зависимости: Next.js 16, React 19.2, TypeScript 5.9, ESLint 9, Tailwind CSS 3.4.18;
- настроен flat-config ESLint (`eslint.config.mjs`) и скрипт `npm run lint`;
- переработана логика измерения скорости с использованием `startTransition`, чтобы избежать каскадных ререндеров;
- добавлены серии измерений, графики динамики и вычисление средних значений по результатам тестов;
- актуализированы инструкции в `README.md`, добавлен раздел про деплой на Vercel и версионирование;
- исправлен `tsconfig.json`, удалены ошибочные пути, добавлена поддержка `.next/dev/types`.

## 1.0.0 — релиз

- начальная версия приложения с измерением скорости загрузки, отдачи и ping;
- поддержка запуска через Next.js и Docker.
